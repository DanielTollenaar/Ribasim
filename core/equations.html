<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Ribasim - Equations</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../core/usage.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../assets/styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="https://user-images.githubusercontent.com/4471859/224825908-bee7e044-bc6b-4561-8b08-5d330cce3ed5.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Ribasim</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../core/index.html" rel="" target="" aria-current="page">
 <span class="menu-text">Julia core</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../python/index.html" rel="" target="">
 <span class="menu-text">Python tooling</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../qgis/index.html" rel="" target="">
 <span class="menu-text">QGIS plugin</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../couple/index.html" rel="" target="">
 <span class="menu-text">Coupled models</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../contribute/index.html" rel="" target="">
 <span class="menu-text">Contributing</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Deltares/Ribasim" rel="" target=""><i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../core/equations.html">Equations</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../core/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Julia core</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../core/usage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Usage</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../core/equations.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Equations</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#formal-model-description" id="toc-formal-model-description" class="nav-link active" data-scroll-target="#formal-model-description"><span class="header-section-number">1</span> Formal model description</a></li>
  <li><a href="#natural-water-balance-terms" id="toc-natural-water-balance-terms" class="nav-link" data-scroll-target="#natural-water-balance-terms"><span class="header-section-number">2</span> Natural water balance terms</a>
  <ul class="collapse">
  <li><a href="#precipitation" id="toc-precipitation" class="nav-link" data-scroll-target="#precipitation"><span class="header-section-number">2.1</span> Precipitation</a></li>
  <li><a href="#evaporation" id="toc-evaporation" class="nav-link" data-scroll-target="#evaporation"><span class="header-section-number">2.2</span> Evaporation</a></li>
  <li><a href="#infiltration-and-drainage" id="toc-infiltration-and-drainage" class="nav-link" data-scroll-target="#infiltration-and-drainage"><span class="header-section-number">2.3</span> Infiltration and Drainage</a></li>
  <li><a href="#upstream-and-downstream-flow" id="toc-upstream-and-downstream-flow" class="nav-link" data-scroll-target="#upstream-and-downstream-flow"><span class="header-section-number">2.4</span> Upstream and downstream flow</a>
  <ul class="collapse">
  <li><a href="#outflowtable" id="toc-outflowtable" class="nav-link" data-scroll-target="#outflowtable"><span class="header-section-number">2.4.1</span> OutflowTable</a></li>
  <li><a href="#linearresistance" id="toc-linearresistance" class="nav-link" data-scroll-target="#linearresistance"><span class="header-section-number">2.4.2</span> LinearResistance</a></li>
  <li><a href="#terminal" id="toc-terminal" class="nav-link" data-scroll-target="#terminal"><span class="header-section-number">2.4.3</span> Terminal</a></li>
  <li><a href="#levelboundary" id="toc-levelboundary" class="nav-link" data-scroll-target="#levelboundary"><span class="header-section-number">2.4.4</span> LevelBoundary</a></li>
  <li><a href="#flowboundary" id="toc-flowboundary" class="nav-link" data-scroll-target="#flowboundary"><span class="header-section-number">2.4.5</span> FlowBoundary</a></li>
  <li><a href="#manning-connection" id="toc-manning-connection" class="nav-link" data-scroll-target="#manning-connection"><span class="header-section-number">2.4.6</span> Manning connection</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#allocated-water-balance-terms" id="toc-allocated-water-balance-terms" class="nav-link" data-scroll-target="#allocated-water-balance-terms"><span class="header-section-number">3</span> Allocated water balance terms</a>
  <ul class="collapse">
  <li><a href="#general-user" id="toc-general-user" class="nav-link" data-scroll-target="#general-user"><span class="header-section-number">3.1</span> General User</a></li>
  <li><a href="#flushing" id="toc-flushing" class="nav-link" data-scroll-target="#flushing"><span class="header-section-number">3.2</span> Flushing</a></li>
  </ul></li>
  <li><a href="#numerical-solution" id="toc-numerical-solution" class="nav-link" data-scroll-target="#numerical-solution"><span class="header-section-number">4</span> Numerical solution</a></li>
  <li><a href="#performance" id="toc-performance" class="nav-link" data-scroll-target="#performance"><span class="header-section-number">5</span> Performance</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Equations</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Ribasim currently simulates the following “natural” water balance terms:</p>
<ol type="1">
<li>Precipitation</li>
<li>Evaporation</li>
<li>Infiltration</li>
<li>Drainage</li>
<li>Urban runoff</li>
<li>Upstream and downstream flow</li>
</ol>
<p>Additionally, Ribasim simulates the following “allocated” water balance terms:</p>
<ol type="1">
<li>General user</li>
<li>Flushing</li>
</ol>
<p>Depending on the type of boundary conditions, Ribasim requires relation between storage volume and wetted area <span class="math inline">\(A\)</span>, and between the storage volume and the water level <span class="math inline">\(h\)</span>. These are (currently) represented by piecewise linear relationships.</p>
<section id="formal-model-description" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Formal model description</h1>
<p>In this section we give a formal description of the problem that is solved by Ribasim. The problem is of the form</p>
<p><span class="math display">\[
\frac{\text{d}\mathbf{u}}{\text{d}t} = f(\mathbf{u},p(t),t),\quad t \in [t_0,t_\text{end}],
\]</span></p>
<p>i.e.&nbsp;a system of coupled first order ordinary differential equations, with initial condition <span class="math inline">\(\mathbf{u}(t_0)= \mathbf{u}_0\)</span> and time dependent input data denoted by <span class="math inline">\(p(t)\)</span>.</p>
<p>The model is given by a directed graph, consisting of a set of nodes (or vertices) <span class="math inline">\(V\)</span> and edges <span class="math inline">\(E\)</span>. Let <span class="math inline">\(V\)</span> be the set of node IDs and let <span class="math inline">\(E\)</span> be the set of ordered tuples <span class="math inline">\((i,j)\)</span> meaning that node <span class="math inline">\(i\)</span> is connected to node <span class="math inline">\(j\)</span>.</p>
<p>We can split the set of nodes into two subsets <span class="math inline">\(V = B \cup N\)</span>, where <span class="math inline">\(B\)</span> is the set of basins and <span class="math inline">\(N\)</span> is the set of non-basins. The basins have an associated storage state and the non-basins dictate how water flows to or from basins.</p>
<p><span class="math inline">\(\mathbf{u}(t)\)</span> is given by all the states of the model, which are (currently) the storage of the basins. Given a single basin with node ID <span class="math inline">\(i \in B\)</span>, the equation that dictates the change of its storage over time is given by</p>
<p><span class="math display">\[
\frac{\text{d}S_i}{\text{d}t} =
\sum_{(i',j') \in E | j' = i} Q_{i',j'} - \sum_{(i',j') \in E | i' = i} Q_{i',j'} + F_i(\mathbf{u},p,t).
\]</span></p>
<p>Here <span class="math inline">\(Q_{i,j}\)</span> is the flow along an edge, where the graph direction dictates positive flow. So the first term denotes flow towards the basin, the second one denotes flow away from the basin, and the third term denotes external forcing. <span class="math inline">\(F_i(\mathbf{u},p,t)\)</span> is given by input data and the current state of the model, and <span class="math inline">\(Q_{i' ,j'}\)</span> is determined by the type of nodes that connect to that edge.</p>
<p>The various node and forcing types that the model can contain are explained below.</p>
</section>
<section id="natural-water-balance-terms" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Natural water balance terms</h1>
<section id="precipitation" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="precipitation"><span class="header-section-number">2.1</span> Precipitation</h2>
<p>The precipitation term is given by</p>
<p><span id="eq-precip"><span class="math display">\[
    Q_P = P \cdot A(S).
\tag{1}\]</span></span></p>
<p>Here <span class="math inline">\(P = P(t)\)</span> is the precipitation rate and <span class="math inline">\(A\)</span> is the wetted area. <span class="math inline">\(A\)</span> is a function of the storage <span class="math inline">\(S = S(t)\)</span>: as the volume of water changes, the area of the free water surface may change as well, depending on the slopes of the surface waters.</p>
</section>
<section id="evaporation" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="evaporation"><span class="header-section-number">2.2</span> Evaporation</h2>
<p>The evaporation term is given by</p>
<p><span id="eq-evap"><span class="math display">\[
    Q_E = E_\text{pot} \cdot A(S) \cdot r.
\tag{2}\]</span></span></p>
<p>Here <span class="math inline">\(E_\text{pot} = E_\text{pot}(t)\)</span> is the potential evaporation rate and <span class="math inline">\(A\)</span> is the wetted area. <span class="math inline">\(r\)</span> is the reduction factor which depends on the depth <span class="math inline">\(d\)</span> and is given by <span id="eq-reduc"><span class="math display">\[
    r = \frac{\min\{d,0.1\}}{0.1} \le 1.
\tag{3}\]</span></span> It provides a smooth gradient as <span class="math inline">\(S \rightarrow 0\)</span> (but not at <span class="math inline">\(d=0.1\)</span>).</p>
<p>A straightforward formulation <span class="math inline">\(Q_E = \mathrm{max}(E_\text{pot} A(S), 0)\)</span> is unsuitable, as <span class="math inline">\(\frac{\mathrm{d}Q_E}{\mathrm{d}S}(S=0)\)</span> is then not well-defined.</p>
<!--
A hyperbolic tangent is a commonly used activation function
[@enwiki:1106669904] to approximate on-off behavior while preserving a smooth
derivative.
-->
<p>A non-smooth derivative results in extremely small timesteps and long computation time: ModelingToolkit identifies the singular behavior and adjusts its timestepping. In a physical interpretation, evaporation is switched on or off per individual droplet of water. In general, the effect of the reduction term is negligible, or not even necessary. As a surface water dries, its wetted area decreases and so does the evaporative flux. However, for (simplified) cases with constant wetted surface (a rectangular profile), evaporation only stops at <span class="math inline">\(S = 0\)</span>.</p>
</section>
<section id="infiltration-and-drainage" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="infiltration-and-drainage"><span class="header-section-number">2.3</span> Infiltration and Drainage</h2>
<p>Infiltration is provided as a lump sum for the basin. If Ribasim is coupled with MODFLOW 6, the infiltration is computed as the sum of all <strong>positive</strong> flows of the MODFLOW 6 boundary conditions in the basin:</p>
<p><span class="math display">\[
    Q_\text{inf} = \sum_{i=1}^{n} \sum_{j=1}^{m} \max(Q_{\mathrm{mf6}_{i,j}}, 0.0)
\]</span> {#eq-inf}.</p>
<p>Where <span class="math inline">\(i\)</span> is the index of the boundary condition, <span class="math inline">\(j\)</span> the MODFLOW 6 cell index, <span class="math inline">\(n\)</span> the number of boundary conditions, and <span class="math inline">\(m\)</span> the number of MODFLOW 6 cells in the basin. <span class="math inline">\(Q_{\mathrm{mf6}_{i,j}}\)</span> is the flow computed by MODFLOW 6 for cell <span class="math inline">\(j\)</span> for boundary condition <span class="math inline">\(i\)</span>.</p>
<p>Drainage is a lump sump for the basin, and consists of the sum of the absolute value of all <strong>negative</strong> flows of the MODFLOW 6 boundary conditions in the basin.</p>
<p><span id="eq-drn"><span class="math display">\[
    Q_\text{drn} = \sum_{i=1}^{n} \sum_{j=1}^{m} \left| \min(Q_{\mathrm{mf6}_{i,j}}, 0.0) \right|
\tag{4}\]</span></span></p>
<p>The interaction with MODFLOW 6 boundary conditions is explained in greater detail in the <a href="../couple/modflow.html">the MODFLOW coupling section</a> of the documentation.</p>
</section>
<section id="upstream-and-downstream-flow" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="upstream-and-downstream-flow"><span class="header-section-number">2.4</span> Upstream and downstream flow</h2>
<p>Ribasim’s basins can be connected to each other, and each basin expects an explicit connection. Two connections are currently available for inter-basin flows:</p>
<ol type="1">
<li><code>OutflowTable</code></li>
<li><code>LinearResistance</code></li>
</ol>
<p>The flow direction of the basin is not pre-determined: flow directions may freely reverse, provided the connection allows it. Currently, a <code>LinearResistance</code> allows bidirectional flow, but the</p>
<p>Additionally, three additional “connections” area available for the “outmost” basins (external nodes) in a network.</p>
<ol type="1">
<li><code>Terminal</code></li>
<li><code>LevelBoundary</code></li>
<li><code>FlowBoundary</code></li>
</ol>
<section id="outflowtable" class="level3" data-number="2.4.1">
<h3 data-number="2.4.1" class="anchored" data-anchor-id="outflowtable"><span class="header-section-number">2.4.1</span> OutflowTable</h3>
<p>The OutflowTable is a tabulation of a basin’s discharge behavior. It describes a piecewise linear relationship between the basin’s storage volume and its discharge. It can be understood as an emprical description of a basin’s properties. This can include a weir, but also the lumped hydraulic behavior of the upstream channels.</p>
<p>The OutflowTable should indicate at which volume no discharge occurs (the dead storage volume).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Currently, the discharge relies only on the basin’s volume; it could also use the volume of both connected basins to simulate backwater effects, submersion of weirs, or even reversal of flows for high precipitation events.</p>
</div>
</div>
</section>
<section id="linearresistance" class="level3" data-number="2.4.2">
<h3 data-number="2.4.2" class="anchored" data-anchor-id="linearresistance"><span class="header-section-number">2.4.2</span> LinearResistance</h3>
<p>A <code>LinearResistance</code> connects two basins together. The flow between the two basins is determined by a linear relationship:</p>
<p><span id="eq-basinflow"><span class="math display">\[
    Q = \frac{h_a - h_b}{R}
\tag{5}\]</span></span></p>
<p>Here <span class="math inline">\(h_a\)</span> is the water level in the first basin, <span class="math inline">\(h_b\)</span> is the water level in the second basin, and <span class="math inline">\(R\)</span> is the resistance of the link. A <code>LinearResistance</code> makes no assumptions about the direction of the flow: water flows from high to low.</p>
</section>
<section id="terminal" class="level3" data-number="2.4.3">
<h3 data-number="2.4.3" class="anchored" data-anchor-id="terminal"><span class="header-section-number">2.4.3</span> Terminal</h3>
<p>This only allows outflow from a basin into a terminal node.</p>
</section>
<section id="levelboundary" class="level3" data-number="2.4.4">
<h3 data-number="2.4.4" class="anchored" data-anchor-id="levelboundary"><span class="header-section-number">2.4.4</span> LevelBoundary</h3>
<p>This can be connected to a basin via a <code>LinearResistance</code>. This boundary node will then exchange water with the basin based on the difference in water level between the two.</p>
</section>
<section id="flowboundary" class="level3" data-number="2.4.5">
<h3 data-number="2.4.5" class="anchored" data-anchor-id="flowboundary"><span class="header-section-number">2.4.5</span> FlowBoundary</h3>
<p>This can be connected directly to a basin and prescribes the flow to or from that basin. We require that the edge connecting the flow boundary to the basin should point towards the basin, so that positive flow corresponds to water being added to the model.</p>
</section>
<section id="manning-connection" class="level3" data-number="2.4.6">
<h3 data-number="2.4.6" class="anchored" data-anchor-id="manning-connection"><span class="header-section-number">2.4.6</span> Manning connection</h3>
<p>Ribasim is capable of simulating steady flow between basins through a reach described by a trapezoidal profile and a Manning roughness coefficient.</p>
<p>We describe the discharge from basin <span class="math inline">\(a\)</span> to basin <span class="math inline">\(b\)</span> solely as a function of the water levels in <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span>.</p>
<p><span class="math display">\[
Q = f(h_a, h_b)
\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(_a\)</span> is the subscript denoting basin <span class="math inline">\(a\)</span></li>
<li><span class="math inline">\(_b\)</span> is the subscript denoting basin <span class="math inline">\(b\)</span></li>
<li><span class="math inline">\(h\)</span> is the hydraulic head, or water level</li>
</ul>
<p>The energy equation for open channel flow is:</p>
<p><span class="math display">\[
H = h + \frac{v^2}{2g}
\]</span></p>
<p>Where</p>
<ul>
<li><span class="math inline">\(H\)</span> is total head</li>
<li><span class="math inline">\(v\)</span> is average water velocity</li>
<li><span class="math inline">\(g\)</span> is gravitational acceleration</li>
</ul>
<p>The discharge <span class="math inline">\(Q\)</span> is defined as:</p>
<p><span class="math display">\[
Q = Av
\]</span></p>
<p>where <span class="math inline">\(A\)</span> is cross-sectional area.</p>
<p>We use conservation of energy to relate the total head at <span class="math inline">\(a\)</span> to <span class="math inline">\(b\)</span>, with <span class="math inline">\(H_a &gt; H_b\)</span> as follows:</p>
<p><span class="math display">\[
H_a = H_b + h_{\text{loss}}
\]</span></p>
<p>Or:</p>
<p><span class="math display">\[
h_a + \frac{v_a^2}{2g} = h_b + \frac{v_b^2}{2g} + h_{\text{loss}}
\]</span></p>
<p>Where <span class="math inline">\(v\)</span> is the average water velocity. <span class="math inline">\(h_{\text{loss}}\)</span> is a combination of friction and contraction/expansion losses:</p>
<p><span class="math display">\[
h_{\text{loss}} = S_f L + \frac{C}{2g} (v_b^2 - v_a^2)
\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(L\)</span> is the reach length</li>
<li><span class="math inline">\(S_f\)</span> is the representative friction slope</li>
<li><span class="math inline">\(C\)</span> is the expansion or contraction coefficient, <span class="math inline">\(0 &lt;= C &lt;=1\)</span></li>
</ul>
<p>We assume velocity differences in a connection are negligible (<span class="math inline">\(v_a = v_b\)</span>):</p>
<p><span class="math display">\[
h_a = h_b + S_f L
\]</span></p>
<p>Friction losses are computed with the Gauckler-Manning formula:</p>
<p><span class="math display">\[
Q = \frac{A}{n} R_h^\frac{2}{3} \sqrt{S_f}
\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(A\)</span> is the <strong>representative</strong> area.</li>
<li><span class="math inline">\(R_h\)</span> is the <strong>representative</strong> wetted radius.</li>
<li><span class="math inline">\(S_f\)</span> is the <strong>representative</strong> friction slope.</li>
<li><span class="math inline">\(n\)</span> is Manning’s roughness coefficient.</li>
</ul>
<p>We can rewrite to express <span class="math inline">\(S_f\)</span> in terms of Q:</p>
<p><span class="math display">\[
S_f = Q^2 \frac{n^2}{A^2 R_h^{4/3}}
\]</span></p>
<p>No water is added or removed in a connection:</p>
<p><span class="math display">\[
Q_a = Q_b = Q
\]</span></p>
<p>Filling in:</p>
<p><span class="math display">\[
h_a = h_b + Q^2 \frac{n^2}{A^2 R_h^{4/3}} L
\]</span></p>
<p>We can then express <span class="math inline">\(Q\)</span> as a function of head difference:</p>
<p><span class="math display">\[
Q = \textrm{sign}(h_a - h_b) \frac{A}{n} R_h^{2/3}\sqrt{\frac{|h_a - h_b|}{L} }
\]</span></p>
<p>The <span class="math inline">\(\textrm{sign}(h_a - h_b)\)</span> term causes the direction of the flow to reverse if the head in basin <span class="math inline">\(b\)</span> is larger than in basin <span class="math inline">\(a\)</span>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The computation of <span class="math inline">\(S_f\)</span> is not exact: we base it on a representative area and hydraulic radius, rather than integrating <span class="math inline">\(S_f\)</span> along the length of a reach. Direct analytic solutions exist for e.g.&nbsp;parabolic profiles (Tolkmitt), but other profiles requires relatively complicated approaches (such as approximating the profile with a polynomial).</p>
<p>Instead, we choose a representative radius and area at the upstream node. This ensures that a basin will still receive water after it has gone dry. The size of the resulting error will depend on the water depth difference between the upstream and downstream basin.</p>
</div>
</div>
<p>The cross sectional area for a trapezoidal or rectangular profile:</p>
<p><span class="math display">\[
A = w d + \frac{\Delta y}{\Delta z} d^2
\]</span></p>
<p>Where</p>
<ul>
<li><span class="math inline">\(w\)</span> is the width at <span class="math inline">\(d = 0\)</span> (A triangular profile has <span class="math inline">\(w = 0\)</span>)</li>
<li><span class="math inline">\(\frac{\Delta y}{\Delta z}\)</span> is the slope of the profile expressed as the horizontal length for one unit in the vertical (A slope of 45 degrees has <span class="math inline">\(\frac{\Delta y}{\Delta z} = 1\)</span>; a rectangular profile 0).</li>
</ul>
<p>Accordingly, the wetted perimeter is:</p>
<p><span class="math display">\[
B = w + 2 d \sqrt{\left(\frac{\Delta y}{\Delta z}\right)^2 + 1}
\]</span></p>
</section>
</section>
</section>
<section id="allocated-water-balance-terms" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Allocated water balance terms</h1>
<p>Ribasim has been designed with the functionality to allocate water to different users within each basin. The volume allocated is determined by the user demand, the available water, and the priority of each user with respect to other users within the same basin. The water demands for a given basin can be summarized into three user categories. The handling of the allocation of water for different user categories varies, as explained in more detail below.</p>
<div class="hidden">
<p><span class="math display">\[
\def\qavail{{Q_\text{avail vol}}}
\def\demwm{{D_{\text{wm}}}}
\def\demuser{{D_\text{user}}}
\]</span></p>
</div>
<section id="general-user" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="general-user"><span class="header-section-number">3.1</span> General User</h2>
<p>The General User category include the users Agriculture, Industry and Public Water supply. These users extract water from the basin and the demand (<span class="math inline">\(\demuser\)</span>) is determined externally. The source of water allocated to the General User is dependent on if the basin is a free-flowing type basin or a level-controlled basin.</p>
<p>If the basin is free-flowing, the water source will be the available water within the basin. If the basin is level-controlled additional water can be sourced from the regional network, should the water available from the basin be insufficient to satisfy <span class="math inline">\(\demuser\)</span>.</p>
<p>The availability of water (<span class="math inline">\(\qavail\)</span>) internally in a basin in a given timestep is calculated by <a href="#eq-q-avail">Equation&nbsp;6</a>. This volume is available to be extracted by the General Users. In the Ribasim prototype, additional water from the regional network is currently modelled as an unlimited supply.</p>
<p><span id="eq-q-avail"><span class="math display">\[
    \qavail = \frac{(P - E_\text{pot}) \cdot A}{\mathrm{Δ}t} - \min(0, Q_\text{infil} - Q_\text{drain} - Q_\text{runoff}).
\tag{6}\]</span></span></p>
<p>Here <span class="math inline">\(A\)</span> is the area. The <span class="math inline">\(\qavail\)</span> can be assigned to multiple users in the same basin. Allocation is based upon user priority. For a given user, in the case where <span class="math inline">\(\qavail &gt; \demuser\)</span>, the user demand is satisfied and the remaining <span class="math inline">\(\qavail\)</span> becomes available for the user of next highest priority. For a given user, in the case where <span class="math inline">\(\demuser &gt; \qavail\)</span> then all of the available water is assigned to the user. This results in an allocation shortage and no remaining local water for any users of lower priority.</p>
<p>However, as discussed, if the basin is a level-controlled basin, additional water can then be sourced from the regional network and is allocated to satisfy the allocation shortage of the General User.</p>
<p>The allocation of water is decided intermittently by a separate process. This separate process is not all-knowing and it may overextract. Like other water balance sinks, negative storage is avoided and smooth numerical behavior is ensured via an activation function:</p>
<p><span id="eq-userflow"><span class="math display">\[
    Q_\text{user} = Q_\text{alloc} \cdot r
\tag{7}\]</span></span></p>
</section>
<section id="flushing" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="flushing"><span class="header-section-number">3.2</span> Flushing</h2>
<p>The flushing requirement for the basin is a special case of user. Flushing is required to maintain water quality in the basin. This is determined externally. Water from the national network flows into the basin, and the same volume gets removed from the basin back to the national network. This water cannot be allocated to other users and there is no net change to the water level in the basin or the <span class="math inline">\(\qavail\)</span>, see <a href="#eq-flushing">Equation&nbsp;8</a>.</p>
<p><span id="eq-flushing"><span class="math display">\[
    Q_\text{in} = -Q_\text{out}
\tag{8}\]</span></span></p>
</section>
</section>
<section id="numerical-solution" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Numerical solution</h1>
<p>Ribasim uses OrdinaryDiffEq.jl to provide a numerical solution to the water balance equations. Changes to forcings or parameters such as precipitation, but also the allocated water abstraction is managed through the use of CallBack functions <span class="citation" data-cites="callbacks">(<a href="#ref-callbacks" role="doc-biblioref">SciML Development Team 2022</a>)</span>. In a coupled run, the exchanges with MODFLOW 6 are also managed via the use of a callback function.</p>
</section>
<section id="performance" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Performance</h1>
<p>Ribasim needs to be sufficiently fast to make application on the national scale, with ~10000 basins, practical. Therefore, whilst developing, we need to be mindful that our approach can scale to such a size. We currently simulate a set of 40 connected free-flowing basins for a period of 2 years in about 10 seconds.</p>
<p>For a real scaling test we would need to do a national simulation, but we expect these computation times not to be problematic, considering that simulating those same 40 basins in MODFLOW 6 takes minutes.</p>
<p>There are many things that can influence the calculations times, for instance:</p>
<ul>
<li><a href="https://diffeq.sciml.ai/stable/basics/faq/#What-does-tolerance-mean-and-how-much-error-should-I-expect">Solver tolerance</a> we currently use a very conservative tolerance of <code>1e-10</code>, whereas with larger tolerances step sizes can easily be 3x longer, leading to a 3x speedup.</li>
<li><a href="https://diffeq.sciml.ai/stable/solvers/ode_solve/">ODE solvers</a>: The <code>Rosenbrock23</code> method we use is robust to oscillations and massive stiffness, however other solvers should be tried as well.</li>
<li>Forcing: Every time new forcing data is injected into the model, it needs to pause. Moreover, the larger the forcing fluxes are, the bigger the shock to the system, leading to smaller timesteps and thus longer simulation times.</li>
</ul>
<p>Similarly to other models that solve using a system of equations, like MODFLOW 6, if one basin takes longer to converge due to extreme forcing, or bad schematization, the system as a whole need to iterate longer. It is important to be mindful of this, as poor schematization choices can slow down the model.</p>
<p>When scaling up the model, we will need spend some time to strike the right balance between error tolerance, schematization and forcing. The SciML software we use has many <a href="https://sciml.ai/showcase/">showcases</a> of large scale applications, as well as documentation on how to achieve the optimal performance for your system.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-callbacks" class="csl-entry" role="listitem">
SciML Development Team. 2022. <span>“Event Handling and Callback Functions.”</span> <a href="https://docs.sciml.ai/DiffEqDocs/latest/features/callback_functions/">https://docs.sciml.ai/DiffEqDocs/latest/features/callback_functions/</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../core/usage.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Usage</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->



</body></html>