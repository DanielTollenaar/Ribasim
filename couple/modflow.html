<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Ribasim - MODFLOW 6</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../couple/modflow-demo.html" rel="next">
<link href="../couple/index.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../assets/styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="https://user-images.githubusercontent.com/4471859/224825908-bee7e044-bc6b-4561-8b08-5d330cce3ed5.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Ribasim</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../core/index.html" rel="" target="">
 <span class="menu-text">Julia core</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../python/index.html" rel="" target="">
 <span class="menu-text">Python tooling</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../qgis/index.html" rel="" target="">
 <span class="menu-text">QGIS plugin</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../couple/index.html" rel="" target="" aria-current="page">
 <span class="menu-text">Coupled models</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../contribute/index.html" rel="" target="">
 <span class="menu-text">Contributing</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Deltares/Ribasim" rel="" target=""><i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../couple/modflow.html">MODFLOW 6</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../couple/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Coupled models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../couple/modflow.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">MODFLOW 6</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../couple/modflow-demo.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MODFLOW 6 Demonstration</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#modflow-concepts" id="toc-modflow-concepts" class="nav-link active" data-scroll-target="#modflow-concepts"><span class="header-section-number">1</span> MODFLOW Concepts</a>
  <ul class="collapse">
  <li><a href="#drainage" id="toc-drainage" class="nav-link" data-scroll-target="#drainage"><span class="header-section-number">1.1</span> Drainage</a></li>
  <li><a href="#river" id="toc-river" class="nav-link" data-scroll-target="#river"><span class="header-section-number">1.2</span> River</a></li>
  </ul></li>
  <li><a href="#coupling" id="toc-coupling" class="nav-link" data-scroll-target="#coupling"><span class="header-section-number">2</span> Coupling</a>
  <ul class="collapse">
  <li><a href="#numerical-solution-in-modflow" id="toc-numerical-solution-in-modflow" class="nav-link" data-scroll-target="#numerical-solution-in-modflow"><span class="header-section-number">2.1</span> Numerical solution in MODFLOW</a></li>
  <li><a href="#sequential-coupled-solution" id="toc-sequential-coupled-solution" class="nav-link" data-scroll-target="#sequential-coupled-solution"><span class="header-section-number">2.2</span> Sequential coupled solution</a></li>
  <li><a href="#iterative-coupled-solution" id="toc-iterative-coupled-solution" class="nav-link" data-scroll-target="#iterative-coupled-solution"><span class="header-section-number">2.3</span> Iterative coupled solution</a>
  <ul class="collapse">
  <li><a href="#drainage-1" id="toc-drainage-1" class="nav-link" data-scroll-target="#drainage-1"><span class="header-section-number">2.3.1</span> Drainage</a></li>
  <li><a href="#river-1" id="toc-river-1" class="nav-link" data-scroll-target="#river-1"><span class="header-section-number">2.3.2</span> River</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#assigning-modflow-water-levels" id="toc-assigning-modflow-water-levels" class="nav-link" data-scroll-target="#assigning-modflow-water-levels"><span class="header-section-number">3</span> Assigning MODFLOW water levels</a>
  <ul class="collapse">
  <li><a href="#parametrization" id="toc-parametrization" class="nav-link" data-scroll-target="#parametrization"><span class="header-section-number">3.1</span> Parametrization</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">MODFLOW 6</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Ribasim has been designed to provide a computationally efficient representation of surface water for MODFLOW 6. It does so by connecting to basic MODFLOW 6 boundary conditions: the river and drainage packages.</p>
<p>Ribasim connects to MODFLOW 6 via the Basic Model Interface (BMI) and Extended Model Interface (XMI) <span class="citation" data-cites="hughes2022modflow">(<a href="#ref-hughes2022modflow" role="doc-biblioref">Hughes et al. 2022</a>)</span>. BMI describes the interface to initialize a model, get values from its memory, run a timestep, etc. XMI extends this interface to allow much finer control into MODFLOW 6’s solution procedures. We have written a Julia package <span class="citation" data-cites="modflowinterface">(<a href="#ref-modflowinterface" role="doc-biblioref">Deltares 2022</a>)</span> which implements this interface for the Julia programming language. In coupling, Ribasim uses this interface to get the head values, the boundary condition water levels, and the budgets term of the MODFLOW 6 groundwater model while MODFLOW 6 is running.</p>
<p>Additionally, links can be made with other (BMI/XMI-compliant) processes and models. One example of such a link is using the surface runoff and the agricultural irrigation demand calculated by an unsaturated zone model; in the Netherlands Hydrological Instrument MetaSWAP provides this demand.</p>
<section id="modflow-concepts" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> MODFLOW Concepts</h1>
<section id="drainage" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="drainage"><span class="header-section-number">1.1</span> Drainage</h2>
<p>The drainage package can be simulated to agricultural drains, ditches, or draining streams. The amount of water removed from the aquifer is proportional to the difference between the groundwater head and the drainage elevation. Drainage only occurs when the head is larger than the elevation; this boundary condition does not allow infiltration into the groundwater.</p>
<p><span class="math display">\[
Q_{drain} = \left\{
    \begin{array}{ c l }
        C_{drain} (\phi - h_{drain}) &amp; \quad \textrm{if } \phi &gt; h_{drain} \\
        0                            &amp; \quad \textrm{otherwise}
     \end{array}
\right.
\]</span></p>
</section>
<section id="river" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="river"><span class="header-section-number">1.2</span> River</h2>
<p>The river package can both drain the groundwater, or infiltrate surface water to the groundwater. It limits the amount of water that can infiltrate when the groundwater head falls below the river bottom, in which cases it assumes atmospheric pressure conditions underneath the surface water.</p>
<p><span class="math display">\[
Q_{river} = \left\{
    \begin{array}{ c l }
        C_{river} (\phi - h_{river}) &amp; \quad \textrm{if } \phi &gt; b_{river} \\
        C_{river} (h_{river} - b_{river}) &amp; \quad \textrm{if } \phi &lt;= b_{river}
     \end{array}
\right.
\]</span></p>
<p>In the Netherlands, it is somewhat common to make a distinction between the drainage and infiltration conductance of surface waters. Drainage conductance is often larger than the infiltration conductance due to clogging processes, seepage through sides of the ditches, less contracted flow lines, etc.</p>
<p><span class="math display">\[
Q_{river} = \left\{
    \begin{array}{ c l }
        C_{river,drn} (\phi - h_{river}) &amp; \quad \textrm{if } \phi &gt; h_{river} \\
        C_{river,inf} (\phi - h_{river}) &amp; \quad \textrm{if } \phi &lt;= h_{river} \\
        C_{river,inf} (h_{river} - b_{river}) &amp; \quad \textrm{if } \phi &lt;= b_{river}
     \end{array}
\right.
\]</span></p>
<p>MODFLOW 6 does not support this (currently), but an identical effect may be achieved by “stacking” a drainage package on top of a river package with these values:</p>
<p><span class="math display">\[
\begin{array}{ c l }
  h_{drain} = h_{river} \\
  C_{drain} = C_{river,drn} - C_{river,inf}
\end{array}
\]</span></p>
</section>
</section>
<section id="coupling" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Coupling</h1>
<p>Broadly speaking, three schemes are commonly considered for coupling hydrological kernels <span class="citation" data-cites="vanwalsum2011integration">(<a href="#ref-vanwalsum2011integration" role="doc-biblioref">Van Walsum and Veldhuizen 2011</a>)</span>, <span class="citation" data-cites="hughes2012documentation">(<a href="#ref-hughes2012documentation" role="doc-biblioref">Hughes et al. 2012</a>)</span>:</p>
<ol type="1">
<li>Sequential: the first model computes a timestep and calculates a state or flux. This is passed on to the second model, which then computes its timestep.</li>
<li>Iterative: the first model computes a timestep and calculates a state or flux. This is passed on to the second models, which computes its timestep. This results in an updated boundary condition for the first model, which recomputes the timestep, then the second model recomputes its timestep, etc. These iterations are repeated until some convergence criteria are met.</li>
<li>Fully coupled: all equations (e.g.&nbsp;the governing equations of both groundwater flow and surface water flow) are solved at the same time.</li>
</ol>
<p>Each scheme has its advantages and disadvantages. Numerically speaking, the fully coupled approach is most robust, but it effectively means a single all-encompassing hydrological kernel. The first scheme is computationally the cheapest, but states and fluxes lag one timestep behind, so that mass conservation is not guaranteed. For example, based on its river levels, MODFLOW 6 may compute a infiltration flux. Ribasim then runs its timestep, and finds that given MODFLOW 6’s infiltration flux, no water is present in the surface waters: the infiltration flux has been overestimated by MODFLOW 6, and mass is not conserved.</p>
<p>Such an error is avoided in the second scheme: states and fluxes only lag a single iteration behind, and the iterations are repeated until the difference is negligible. Taking the example from above, the emptying of the surface waters would result in lower water levels and recuded infiltration in the second iteration. Mass is conserved, but at a higher computational cost.</p>
<p>Currently, we have only implemented the sequential scheme for coupling Ribasim to MODFLOW 6. However, the iterative solution is relatively easy to implement: it is in essence a repeated sequential step.</p>
<section id="numerical-solution-in-modflow" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="numerical-solution-in-modflow"><span class="header-section-number">2.1</span> Numerical solution in MODFLOW</h2>
<p>MODFLOW uses a backward-in-time implicit solution scheme. This creates a large system of equations (a water balance for every cell), which it solves by repeatedly solving a linearized system of equations instead. In matrix form, this system of equations is expressed by:</p>
<p><span class="math display">\[
\mathbf{Ax} = \mathbf{b}
\]</span></p>
<p>Where <span class="math inline">\(\mathbf{x}\)</span> is a vector containing the head of every cell.</p>
<p>For the boundary conditions, this requires linearization of the flow equations. Flow from outside of the aquifer (cell) may be represented by:</p>
<p><span class="math display">\[
a = p\phi + q
\]</span></p>
<p>(Equation 2-6 in the MODFLOW 6 documentation <span class="citation" data-cites="langevin2017documentation">(<a href="#ref-langevin2017documentation" role="doc-biblioref">Langevin et al. 2017</a>)</span>.)</p>
<p>For e.g.&nbsp;a draining boundary condition, the flow is head dependent:</p>
<p><span class="math display">\[
a = C(h - \phi) = -C\phi + Ch
\]</span></p>
<p>With <span class="math inline">\(C\)</span> the conductance, <span class="math inline">\(h\)</span> the boundary head or elevation, and <span class="math inline">\(\phi\)</span> the groundwater head.</p>
<p>In MODFLOW’s internal formulation, the term in <span class="math inline">\(\mathbf{A}\)</span> is called “coefficient of head” or hcof. Terms in <span class="math inline">\(\mathbf{b}\)</span> are called “right hand side” or rhs. We can separate the equation above:</p>
<p><span class="math display">\[
\begin{aligned}
p = \text{hcof} = -C \\
q = \textrm{rhs} = -Ch \\
a = -C\phi + Ch = \text{hcof} * \phi - \text{rhs}
\end{aligned}
\]</span></p>
<p>For every boundary condition, MODFLOW 6 stores the <code>hcof</code> and <code>rhs</code> values. This makes it quite convenient for us to compute the water budget for every boundary condition: we simply multiply the hcof value by the head of the cell and subtract the rhs.</p>
<p>Note that hcof may have a value of 0! For example, when for a river boundary the <span class="math inline">\(\phi &lt;= b_{river}\)</span> condition occurs, the flow into the cell is controlled only by <span class="math inline">\(h_{river}\)</span> and <span class="math inline">\(b_{river}\)</span> (equal to recharge for the linear solution).</p>
</section>
<section id="sequential-coupled-solution" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="sequential-coupled-solution"><span class="header-section-number">2.2</span> Sequential coupled solution</h2>
<p>A coupled run stars by initializing both models and creating the exchange information: which MODFLOW 6 boundary condition is connected to which Ribasim basin. While the model is running, the model proceeds through time as follows:</p>
<ol type="1">
<li>Ribasim solves the equations on a basin level; this occurs with adaptive timestepping via ModelingToolkit.</li>
<li>At a specified time (in accordance with the MODFLOW 6 time discretization), the volumes are converted to MODFLOW 6 boundary condition levels using a Callback function.</li>
<li>MODFLOW 6 runs a timestep.</li>
<li>The drainage and infiltration budgets are computed from MODFLOW 6 using the equations described above and aggregated per basin.</li>
<li>The aggregated values are set as Ribasim boundary conditions, and Ribasim solves until the next preset exchange time.</li>
</ol>
<p>These steps run until the final timestep is finished.</p>
</section>
<section id="iterative-coupled-solution" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="iterative-coupled-solution"><span class="header-section-number">2.3</span> Iterative coupled solution</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>We have not implemented an iterative coupled solution yet. The section below describes an approach.</p>
</div>
</div>
<p>The simplest form of a iterative solution occurs as follows:</p>
<ol type="1">
<li>MODFLOW 6 computes drainage and infiltration flows.</li>
<li>Ribasim uses these flows to compute a storage volume for the basin.</li>
<li>The volume is translated to a water level for every MODFLOW 6 boundary condition in the basins.</li>
<li>MODFLOW 6 recomputes drainage and infiltration flows with the updated water levels, etc.</li>
</ol>
<p>Such a scheme is not maximally efficient: the discharge and infiltration terms are not constant, but are driven by a head difference. This head difference depends on the level of the boundary conditions and head of every cell of the groundwater model. If the surface waters of a basin empty, the water level will decrease and drainage and infiltration flows will change. Ideally, we can provide Ribasim with more information, so that it may estimate drainage and infiltration terms better.</p>
<p>As groundwater flow is often (approximately) linear, we can use linearization to more efficiently compute the flow from Ribasim’s side as well. In the iterative coupled solution, we are solving both MODFLOW 6 and Ribasim repeatedly, until they produce same drainage or infiltration (approximately). One of Ribasim’s basins contains many MODFLOW cells with boundary conditions. We could add every boundary condition to Ribasim’s equations, but this is costly and cumbersome. Fortunately, linearization allows us to “stack” (superpose) all the different boundary conditions into a single, simple equation. In linear form, every equation takes the form of:</p>
<p><span class="math display">\[
a = ph + q
\]</span></p>
<p>Note the <span class="math inline">\(h\)</span> rather than <span class="math inline">\(\phi\)</span>, we are formulating from Ribasim’s perspective! We can sum all coefficients for p and q to provide a linear groundwater response to Ribasim.</p>
<section id="drainage-1" class="level3" data-number="2.3.1">
<h3 data-number="2.3.1" class="anchored" data-anchor-id="drainage-1"><span class="header-section-number">2.3.1</span> Drainage</h3>
<p>From Ribasim’s perspective, the groundwater head is constant given a timestep, so that:</p>
<p><span class="math display">\[
\begin{align}
p = -C \\
q = -C\phi
\end{align}
\]</span></p>
<p>When the head falls below the drainage elevation, the coefficients are 0.</p>
</section>
<section id="river-1" class="level3" data-number="2.3.2">
<h3 data-number="2.3.2" class="anchored" data-anchor-id="river-1"><span class="header-section-number">2.3.2</span> River</h3>
<p>From Ribasim’s perspective, infiltration is never limited when the head falls below the bottom:</p>
<p><span class="math display">\[
\begin{align}
p = -C \\
q = -Cb
\end{align}
\]</span></p>
<p>Otherwise, infiltration and drainage occur with the same equation as for the drainage package:</p>
<p><span class="math display">\[
\begin{align}
p = -C \\
q = -C\phi
\end{align}
\]</span></p>
</section>
</section>
</section>
<section id="assigning-modflow-water-levels" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Assigning MODFLOW water levels</h1>
<p>Principally, MODFLOW deals with water levels; Ribasim deals with water volumes. The translation from a water volume to a water level for a single boundary condition is straightforward:</p>
<p><span class="math display">\[
\begin{align}
\Delta d = \frac{\Delta V}{A} \\
h = b + d
\end{align}
\]</span></p>
<p>Where <span class="math inline">\(d\)</span> is water depth, <span class="math inline">\(V\)</span> is volume, <span class="math inline">\(A\)</span> is area, <span class="math inline">\(h\)</span> is water level, and <span class="math inline">\(b\)</span> is the bed elevation.</p>
<p>However, the primary complication is that where Ribasim has <strong>one volume</strong>, MODFLOW has <strong>many levels</strong> to adjust. The sum of all these adjustments times their respective areas should result in the basin volume change:</p>
<p><span class="math display">\[
\sum_{i=1}^{j=m} \sum_{j=1}^{i=n} \Delta d_{i,j} A_{i,j} = \Delta V_{basin}
\]</span></p>
<p>where <span class="math inline">\(i\)</span> is the index of the boundary condition and <span class="math inline">\(j\)</span> the index of the cell.</p>
<p>It should be obvious that there are many ways to distribute this volume change across the adjustment of every boundary condition of every cell. The main question is when the basin volume grows or decreases, how should this volume change be distributed across the basin?</p>
<p>The best method to find an answer to this question is to run a hydraulic model, extract water heights, and compute the total volume. This can then be used as a lookup table for every cell. These runs can also be used for parametrizing the volume-discharge lookup tables. In coupling to Ribasim, we need only find the appropriate volume and assign the associated water level. For efficiency, this lookup table can be discretized in a limited number of steps, and in coupling the level will be interpolated.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Great care is required when parametrizing these volume-level relationships. As Ribasim does not know the properties of the surface water, it can perform very limited validation of the volume-level lookup tables. As the total volume of the basin is distributed across <strong>all</strong> boundary conditions, it should be checked that the change of the water column for every boundary condition matches the total volume change of the basin.</p>
</div>
</div>
<p>In principle, all (stationary!) hydraulic behavior of the basin can be described approximately by these lookup tables.</p>
<section id="parametrization" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="parametrization"><span class="header-section-number">3.1</span> Parametrization</h2>
<p>In coupling Ribasim to MODFLOW 6, relations translating the Ribasim volume must be given <strong>for every every cell</strong> of every boundary condition. These consist of piecewise linear relationships between the basin volume and its associated water level for the boundary condition in the cell.</p>
<p>These values are stored in a netCDF dataset. This dataset must meet the following requirements:</p>
<ol type="1">
<li>It must contain a <code>x</code> and <code>y</code> coordinate. The extent and cell size of these coordinates must match the domain of the coupled MODFLOW 6 model exactly.</li>
<li>It must contain a variable (x, y) denoting the basin IDs.</li>
<li>It must contain a volume-level variable (x, y, row, column) for every coupled MODFLOW 6 boundary condition, describing the volume-level lookup table per cell.</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>x</code> and <code>y</code> coordinates are valid for structured MODFLOW 6 models (DIS). Discretized-by-vertices (DISV) and fully unstructured discretization (DISU). are not yet supported, but require no fundamental changes: one basin is connected to multiple MODFLOW 6 cells, and the coupling parameters must match the (structured, unstructured) grid of the MODFLOW 6 model exactly.</p>
</div>
</div>
<p>The MODFLOW 6 coupling example cases show examples of such a parametrization.</p>



</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-modflowinterface" class="csl-entry" role="listitem">
Deltares. 2022. <span>“ModflowInterface.jl.”</span> <a href="https://github.com/Deltares/ModflowInterface.jl">https://github.com/Deltares/ModflowInterface.jl</a>.
</div>
<div id="ref-hughes2012documentation" class="csl-entry" role="listitem">
Hughes, Joseph D, Christian D Langevin, Kevin L Chartier, and Jeremy T White. 2012. <em>Documentation of the Surface-Water Routing (SWR1) Process for Modeling Surface-Water Flow with the US Geological Survey Modular Groundwater Model (MODFLOW-2005)</em>. US Department of the Interior, US Geological Survey.
</div>
<div id="ref-hughes2022modflow" class="csl-entry" role="listitem">
Hughes, Joseph D, Martijn J Russcher, Christian D Langevin, Eric D Morway, and Richard R McDonald. 2022. <span>“The MODFLOW Application Programming Interface for Simulation Control and Software Interoperability.”</span> <em>Environmental Modelling &amp; Software</em> 148: 105257.
</div>
<div id="ref-langevin2017documentation" class="csl-entry" role="listitem">
Langevin, Christian D, Joseph D Hughes, Edward R Banta, Richard G Niswonger, Sorab Panday, and Alden M Provost. 2017. <span>“Documentation for the MODFLOW 6 Groundwater Flow Model.”</span> US Geological Survey.
</div>
<div id="ref-vanwalsum2011integration" class="csl-entry" role="listitem">
Van Walsum, PEV, and AA Veldhuizen. 2011. <span>“Integration of Models Using Shared State Variables: Implementation in the Regional Hydrologic Modelling System SIMGRO.”</span> <em>Journal of Hydrology</em> 409 (1-2): 363–70.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../couple/index.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Coupled models</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../couple/modflow-demo.html" class="pagination-link">
        <span class="nav-page-text">MODFLOW 6 Demonstration</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>